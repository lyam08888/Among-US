<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test d'Int√©gration - Syst√®me de Personnalisation</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-family: 'Inter', Arial, sans-serif;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .test-card h3 {
            margin-top: 0;
            color: #fff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        
        .test-result {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .test-success {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
        }
        
        .test-error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }
        
        .test-warning {
            background: rgba(255, 193, 7, 0.3);
            border: 1px solid #FFC107;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        .preview-canvas {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üß™ Test d'Int√©gration - Syst√®me de Personnalisation</h1>
            <p>V√©rification compl√®te de l'int√©gration du g√©n√©rateur de personnages</p>
        </div>
        
        <div class="test-grid">
            <!-- Test 1: Chargement des Scripts -->
            <div class="test-card">
                <h3>üì¶ Chargement des Scripts</h3>
                <div id="script-tests"></div>
                <button onclick="testScriptLoading()">Tester le Chargement</button>
            </div>
            
            <!-- Test 2: G√©n√©rateur de Base -->
            <div class="test-card">
                <h3>‚öôÔ∏è G√©n√©rateur de Base</h3>
                <div id="generator-tests"></div>
                <canvas id="generator-canvas" class="preview-canvas" width="150" height="150"></canvas>
                <button onclick="testGenerator()">Tester le G√©n√©rateur</button>
            </div>
            
            <!-- Test 3: Presets -->
            <div class="test-card">
                <h3>üé® Presets</h3>
                <div id="preset-tests"></div>
                <div id="preset-previews" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
                <button onclick="testPresets()">Tester les Presets</button>
            </div>
            
            <!-- Test 4: Customizer -->
            <div class="test-card">
                <h3>üõ†Ô∏è Interface de Personnalisation</h3>
                <div id="customizer-tests"></div>
                <button onclick="testCustomizer()">Tester le Customizer</button>
                <button onclick="openCustomizer()">Ouvrir l'Interface</button>
            </div>
            
            <!-- Test 5: Sauvegarde -->
            <div class="test-card">
                <h3>üíæ Syst√®me de Sauvegarde</h3>
                <div id="storage-tests"></div>
                <button onclick="testStorage()">Tester la Sauvegarde</button>
                <button onclick="clearStorage()">Vider le Cache</button>
            </div>
            
            <!-- Test 6: Performance -->
            <div class="test-card">
                <h3>‚ö° Performance</h3>
                <div id="performance-tests"></div>
                <canvas id="performance-canvas" class="preview-canvas" width="150" height="150"></canvas>
                <button onclick="testPerformance()">Test de Performance</button>
            </div>
        </div>
        
        <!-- Console de Debug -->
        <div class="test-card">
            <h3>üîç Console de Debug</h3>
            <div id="debug-log" class="log-container"></div>
            <button onclick="clearLog()">Vider la Console</button>
            <button onclick="exportResults()">Exporter les R√©sultats</button>
        </div>
    </div>

    <!-- Scripts n√©cessaires -->
    <script src="js/crewmate-generator.js"></script>
    <script src="js/character-customizer.js"></script>
    
    <script>
        // Syst√®me de logging
        const debugLog = document.getElementById('debug-log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #888">[${timestamp}]</span> ${message}`;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function showResult(containerId, message, success) {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${success ? 'test-success' : 'test-error'}`;
            result.textContent = message;
            container.appendChild(result);
        }
        
        // Test 1: Chargement des Scripts
        function testScriptLoading() {
            log('üß™ Test du chargement des scripts...');
            
            const tests = [
                { name: 'CrewmateGenerator', obj: window.CrewmateGenerator },
                { name: 'CharacterCustomizer', obj: window.CharacterCustomizer },
                { name: 'CrewmatePresets', obj: window.CrewmateGenerator?.CrewmatePresets }
            ];
            
            tests.forEach(test => {
                const success = !!test.obj;
                showResult('script-tests', `${test.name}: ${success ? 'OK' : 'ERREUR'}`, success);
                log(`Script ${test.name}: ${success ? 'charg√©' : 'manquant'}`);
            });
        }
        
        // Test 2: G√©n√©rateur de Base
        function testGenerator() {
            log('üß™ Test du g√©n√©rateur de base...');
            
            if (!window.CrewmateGenerator) {
                showResult('generator-tests', 'CrewmateGenerator non disponible', false);
                return;
            }
            
            try {
                const canvas = document.getElementById('generator-canvas');
                const options = window.CrewmateGenerator.CrewmatePresets.Classic();
                const state = { anim: 'idle', frame: 0, dir: 3 };
                
                window.CrewmateGenerator.renderFrameToCanvas(canvas, options, state);
                showResult('generator-tests', 'Rendu de base: OK', true);
                log('‚úÖ Rendu de base r√©ussi');
                
                // Test sprite sheet
                const sheet = window.CrewmateGenerator.buildSpriteSheet(options, { frames: 4, dirs: 2, ssaa: 1 });
                showResult('generator-tests', `Sprite sheet: ${sheet ? 'OK' : 'ERREUR'}`, !!sheet);
                log(`Sprite sheet: ${sheet ? 'g√©n√©r√©' : '√©chec'}`);
                
            } catch (error) {
                showResult('generator-tests', `Erreur: ${error.message}`, false);
                log(`‚ùå Erreur g√©n√©rateur: ${error.message}`);
            }
        }
        
        // Test 3: Presets
        function testPresets() {
            log('üß™ Test des presets...');
            
            if (!window.CrewmateGenerator?.CrewmatePresets) {
                showResult('preset-tests', 'Presets non disponibles', false);
                return;
            }
            
            const presets = ['Classic', 'Slim', 'Chunky', 'Heroic'];
            const previewContainer = document.getElementById('preset-previews');
            previewContainer.innerHTML = '';
            
            presets.forEach(presetName => {
                try {
                    const preset = window.CrewmateGenerator.CrewmatePresets[presetName]();
                    const canvas = document.createElement('canvas');
                    canvas.width = 80;
                    canvas.height = 80;
                    canvas.style.border = '1px solid rgba(255,255,255,0.3)';
                    canvas.style.borderRadius = '8px';
                    canvas.title = presetName;
                    
                    const state = { anim: 'idle', frame: 0, dir: 3 };
                    window.CrewmateGenerator.renderFrameToCanvas(canvas, preset, state);
                    
                    previewContainer.appendChild(canvas);
                    showResult('preset-tests', `${presetName}: OK`, true);
                    log(`‚úÖ Preset ${presetName} charg√©`);
                    
                } catch (error) {
                    showResult('preset-tests', `${presetName}: ERREUR`, false);
                    log(`‚ùå Erreur preset ${presetName}: ${error.message}`);
                }
            });
        }
        
        // Test 4: Customizer
        function testCustomizer() {
            log('üß™ Test de l\'interface de personnalisation...');
            
            try {
                // Test de cr√©ation
                const mockApp = { showToast: () => {} };
                const customizer = new CharacterCustomizer(mockApp);
                showResult('customizer-tests', 'Cr√©ation: OK', true);
                log('‚úÖ CharacterCustomizer cr√©√©');
                
                // Test export
                const options = customizer.exportCharacterOptions();
                showResult('customizer-tests', `Export: ${options ? 'OK' : 'ERREUR'}`, !!options);
                log(`Export options: ${options ? 'r√©ussi' : '√©chec'}`);
                
                // Test g√©n√©ration sprite sheet
                const sheet = customizer.generateSpriteSheet();
                showResult('customizer-tests', `Sprite sheet: ${sheet ? 'OK' : 'ERREUR'}`, !!sheet);
                log(`G√©n√©ration sprite sheet: ${sheet ? 'r√©ussie' : '√©chec'}`);
                
            } catch (error) {
                showResult('customizer-tests', `Erreur: ${error.message}`, false);
                log(`‚ùå Erreur customizer: ${error.message}`);
            }
        }
        
        // Test 5: Sauvegarde
        function testStorage() {
            log('üß™ Test du syst√®me de sauvegarde...');
            
            try {
                // Test localStorage
                const testData = { test: 'data', timestamp: Date.now() };
                localStorage.setItem('test_customization', JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem('test_customization'));
                
                const success = retrieved && retrieved.test === 'data';
                showResult('storage-tests', `localStorage: ${success ? 'OK' : 'ERREUR'}`, success);
                log(`Test localStorage: ${success ? 'r√©ussi' : '√©chec'}`);
                
                // Test sauvegarde personnage
                if (window.CharacterCustomizer) {
                    const mockApp = { 
                        showToast: () => {},
                        savePlayerCustomization: (id, options) => {
                            localStorage.setItem(`amongus_player_${id}`, JSON.stringify(options));
                            return true;
                        }
                    };
                    
                    const customizer = new CharacterCustomizer(mockApp);
                    customizer.saveCharacter();
                    
                    const saved = localStorage.getItem('amongus_character');
                    showResult('storage-tests', `Sauvegarde personnage: ${saved ? 'OK' : 'ERREUR'}`, !!saved);
                    log(`Sauvegarde personnage: ${saved ? 'r√©ussie' : '√©chec'}`);
                }
                
                // Nettoyage
                localStorage.removeItem('test_customization');
                
            } catch (error) {
                showResult('storage-tests', `Erreur: ${error.message}`, false);
                log(`‚ùå Erreur sauvegarde: ${error.message}`);
            }
        }
        
        // Test 6: Performance
        function testPerformance() {
            log('üß™ Test de performance...');
            
            if (!window.CrewmateGenerator) {
                showResult('performance-tests', 'G√©n√©rateur non disponible', false);
                return;
            }
            
            const canvas = document.getElementById('performance-canvas');
            const options = window.CrewmateGenerator.CrewmatePresets.Classic();
            
            // Test de rendu multiple
            const startTime = performance.now();
            const iterations = 100;
            
            for (let i = 0; i < iterations; i++) {
                const state = { anim: 'idle', frame: i % 8, dir: (i % 4) };
                window.CrewmateGenerator.renderFrameToCanvas(canvas, options, state);
            }
            
            const endTime = performance.now();
            const totalTime = endTime - startTime;
            const avgTime = totalTime / iterations;
            
            showResult('performance-tests', `${iterations} rendus en ${totalTime.toFixed(2)}ms`, true);
            showResult('performance-tests', `Moyenne: ${avgTime.toFixed(2)}ms par rendu`, avgTime < 10);
            
            log(`‚ö° Performance: ${avgTime.toFixed(2)}ms/rendu (${iterations} tests)`);
            
            // Test m√©moire
            const memoryBefore = performance.memory ? performance.memory.usedJSHeapSize : 0;
            
            // Cr√©er plusieurs instances
            const instances = [];
            for (let i = 0; i < 10; i++) {
                instances.push(window.CrewmateGenerator.CrewmatePresets.Classic());
            }
            
            const memoryAfter = performance.memory ? performance.memory.usedJSHeapSize : 0;
            const memoryDiff = memoryAfter - memoryBefore;
            
            if (performance.memory) {
                showResult('performance-tests', `M√©moire utilis√©e: ${(memoryDiff / 1024).toFixed(2)}KB`, memoryDiff < 1024 * 100);
                log(`üíæ Utilisation m√©moire: ${(memoryDiff / 1024).toFixed(2)}KB`);
            }
        }
        
        // Utilitaires
        function openCustomizer() {
            if (window.amongUsApp && window.amongUsApp.showCharacterCustomizer) {
                window.amongUsApp.showCharacterCustomizer();
                log('üé® Interface de personnalisation ouverte');
            } else {
                log('‚ùå Application principale non disponible');
            }
        }
        
        function clearStorage() {
            const keys = Object.keys(localStorage).filter(key => 
                key.includes('amongus') || key.includes('character') || key.includes('customization')
            );
            
            keys.forEach(key => localStorage.removeItem(key));
            log(`üóëÔ∏è ${keys.length} √©l√©ments supprim√©s du cache`);
        }
        
        function clearLog() {
            debugLog.innerHTML = '';
        }
        
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                tests: {
                    scripts: !!window.CrewmateGenerator,
                    generator: true,
                    presets: !!window.CrewmateGenerator?.CrewmatePresets,
                    customizer: !!window.CharacterCustomizer,
                    storage: typeof Storage !== 'undefined'
                },
                logs: debugLog.textContent
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customization-test-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('üìÑ R√©sultats export√©s');
        }
        
        // Auto-test au chargement
        window.addEventListener('load', () => {
            log('üöÄ D√©marrage des tests automatiques...');
            setTimeout(() => {
                testScriptLoading();
                testGenerator();
                testPresets();
            }, 500);
        });
    </script>
</body>
</html>